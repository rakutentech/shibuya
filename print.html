<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Shibuya Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Shibuya Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Shibuya is a load test scheduling tool.</p>
<p>This book will provide two types of guides(Please check the links in the left index):</p>
<ol>
<li>People who want to run Shibuya as a service. <a href="ops/ops_intro.html">click here</a></li>
<li>People who are using Shibuya. <a href="user/user_guide_intro.html">click here</a></li>
<li>People who are Shibuya developers.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-run-shibuya"><a class="header" href="#how-to-run-shibuya">How to Run Shibuya</a></h1>
<p>In this chapter, we will discuss how you can setup Shibuya as a service, internally or on public cloud, so that you can provide Shibuya as a service to your users.</p>
<p>Let's start with basic requirements.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup-the-dependencies"><a class="header" href="#setup-the-dependencies">Setup the dependencies</a></h1>
<p>Shibuya relies on below components:</p>
<ul>
<li>shibuya-controller: The actual process that handles all the Shibuya business logic</li>
<li>Kubernetes: Shibuya deploys all the load generators into a kubernetes cluster</li>
<li>MySQL: all the session data and business logic</li>
<li>Grafana: Metrics collected by Prometheus will be rendered at Grafana</li>
<li>Prometheus: Metrics collected from the load generators will be scraped by Prom.</li>
</ul>
<p>We will discuss each of this dependencies separately.</p>
<h2 id="architecture-overview"><a class="header" href="#architecture-overview">Architecture Overview</a></h2>
<p><img src="ops/../images/shibuya-architecture.png" alt="image" /></p>
<h2 id="shibuya-controller"><a class="header" href="#shibuya-controller">Shibuya-controller</a></h2>
<p>We don't limit how you deploy the shibuya controller. The process it self is running inside a Docker container and is listening on 8080 port. In <a href="ops/./docker.html">this page</a>, we will explain how you can build your own shibuya controller. Moreover, Each shibuya controller is configured by a configuration file called <code>config.json</code>. The details can be read <a href="ops/./config.html">here</a>.</p>
<h2 id="kubernetes"><a class="header" href="#kubernetes">Kubernetes</a></h2>
<p>Current supported versions should work well with Shibuya.</p>
<p>Please follow below steps to setup the k8s cluster:</p>
<ol>
<li><code>kubect create ns shibuya-executors</code></li>
</ol>
<h2 id="load-generators"><a class="header" href="#load-generators">Load generators</a></h2>
<h3 id="jmeter"><a class="header" href="#jmeter">Jmeter</a></h3>
<p>Currently Jmeter is the only engine Shibuya supports. (We need to provide a public Jmeter image)</p>
<h2 id="object-storage"><a class="header" href="#object-storage">Object Storage</a></h2>
<p>We use object storage to store all the test plans and their related files, for example, csv files.
Currently we support two types of storage:</p>
<ol>
<li>HTTP REST based API object storage(Nexus)</li>
<li>GCP bucket.</li>
</ol>
<p>Please go to <a href="ops/./object_storage.html">here</a> to see the detail guide.</p>
<h2 id="mysql"><a class="header" href="#mysql">MySQL</a></h2>
<p>Internally, we are using fork of MySQL, MariaDB. But current versions of MySQL should work well with Shibuya.</p>
<p>All the schema files are stored under db folder. You just need to load the schemas into the database.</p>
<h2 id="grafana"><a class="header" href="#grafana">Grafana</a></h2>
<h2 id="prometheus"><a class="header" href="#prometheus">Prometheus</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="authentication-model-and-multi-tenancy"><a class="header" href="#authentication-model-and-multi-tenancy">Authentication model and multi tenancy</a></h1>
<h2 id="basic"><a class="header" href="#basic">Basic</a></h2>
<p>Currently, Shibuya supports LDAP based authentication and no authentication. No authentication is mostly used by Shibuya developers.</p>
<p>Please bear in mind, a more robust authentication is still WIP. It's not recommended to run Shibuya in a public network.</p>
<p>If you choose to disable authentication, that also disables multi tenancy. All the resources will be belong to a hardcoded user name <code>shibuya</code>.</p>
<h2 id="ldap-authentication"><a class="header" href="#ldap-authentication">LDAP authentication</a></h2>
<p>When user logs in, all the credentials will be checked against a configured LDAP server. Once it's validated, the mailing list of this user will be stored and later used as ownership source. In other words, all the resources created by the user belong to the mailing lists users are in.</p>
<p>All the LDAP related configurations will be explained at this <a href="ops/./config.html">chaper</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dockerfile"><a class="header" href="#dockerfile">Dockerfile</a></h1>
<p>Shibuya controller runs inside a Docker container. In order to sucessfully build a Docker image for your own controller, you will need these files:</p>
<ol>
<li>kubeconfig</li>
<li>GCP config JSON (only if you are using GCP)</li>
<li>Config file for shibuya controller itself.</li>
</ol>
<h2 id="kubeconfig-and-shibuya-controller-config"><a class="header" href="#kubeconfig-and-shibuya-controller-config">kubeconfig and shibuya controller config</a></h2>
<pre><code>COPY config/kube_configs /root/.kube
COPY config_${env}.json /config.json
</code></pre>
<p>For kubeconfig, as you can see in the Dockerfile , you only need to provide the kubeconfigs here: <code>shibuya/shibuya/config/kube_configs</code>.</p>
<p>For the shibuya config file, you will need to put it here <code>shibuya/shibuya</code>, which is the building context of this Dockerfile. <code>${env}</code> here is the building argument. If your k8s cluster is <code>gcp_tokyo</code>, you can name your config file as <code>config_gcp_tokyo</code> and build the Docker image as follows:</p>
<p><code>docker build -t ${image_name} --build-arg env=gcp_tokyo .</code></p>
<h2 id="gcp-config"><a class="header" href="#gcp-config">GCP config</a></h2>
<pre><code>ADD ./shibuya-gcp.json /auth/shibuya-gcp.json
</code></pre>
<p>You will need to add the gcp auth file to the build context, which you can learn here: <a href="https://cloud.google.com/docs/authentication/getting-started">https://cloud.google.com/docs/authentication/getting-started</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration-explanation"><a class="header" href="#configuration-explanation">Configuration Explanation</a></h1>
<p>Below is a sample configuration of Shibuya. We will explain them by sections.</p>
<pre><code>{
    "bg_color": "#fff",
    "project_home": "",
    "upload_file_help": "",
    "auth_config": {
        "admin_users": [],
        "ldap_server": "",
        "ldap_port": "",
        "system_user": "",
        "system_password": "",
        "base_dn": "",
        "no_auth": true
    },
    "http_config": {
        "proxy": ""
    },
    "db": {
        "host": "db",
        "user": "root",
        "password": "root",
        "database": "shibuya"
    },
    "executors": {
        "cluster": {
            "on_demand": false
        },
        "in_cluster": true,
        "namespace": "shibuya-executors",
        "jmeter": {
            "image": "shibuya:jmeter",
            "cpu": "1",
            "mem": "512Mi"
        },
        "pull_secret": "",
        "pull_policy": "IfNotPresent"
    },
    "dashboard": {
        "url": "http://localhost:3000",
        "run_dashboard": "/d/RXY8nM1mk2/shibuya",
        "engine_dashboard": "/d/9EH6xqTZz/shibuya-engine-health"
    },
    "object_storage": {
        "provider": "local",
        "url": "http://storage:8080",
        "user": "",
        "password": ""
    },
    "log_format": {
        "json": false
    }
}
</code></pre>
<h2 id="general-configs"><a class="header" href="#general-configs">General Configs</a></h2>
<pre><code>    "bg_color": "#fff",  # UI bg colour. Could be useful when you are using Shibuya in multiple networking environments.
    "project_home": "",
    "upload_file_help": "", # Document link for uploading the file
</code></pre>
<h2 id="auth-related"><a class="header" href="#auth-related">Auth related</a></h2>
<p>All authentication related logic is configured by this block</p>
<pre><code>    "auth_config": {
        "admin_users": [], # admin mailing list. A admin will have a dedicated page to view all the running collections
        "ldap_server": "", 
        "ldap_port": "",
        "system_user": "", # ldap system user
        "system_password": "", # ldap system pwd
        "base_dn": "",
        "no_auth": true # Turn off auth completely
    }
</code></pre>
<h2 id="http-client"><a class="header" href="#http-client">HTTP client</a></h2>
<p>Once this is configured, all the traffic will pass through proxy. Including metrics streaming and requests to k8s cluster.</p>
<pre><code>    "http_config": {
        "proxy": ""
    }
</code></pre>
<h2 id="db-configurations"><a class="header" href="#db-configurations">DB configurations</a></h2>
<pre><code>    "db": {
        "host": "db",
        "user": "root",
        "password": "root",
        "database": "shibuya"
    }
</code></pre>
<h2 id="executor-configurations"><a class="header" href="#executor-configurations">Executor configurations</a></h2>
<p>Shibuya supports two types of clusters:</p>
<ol>
<li>on demand, specifically, GKE in Google Cloud Platform.</li>
<li>on-premise cluster.</li>
</ol>
<p>With on demand mode, Shibuya is able to automatically create nodes and clean resources after usage. In most cases, the GKE cluster used by Shibuya has 0 worker nodes(to save money).</p>
<p>Shibuya controller can be run outside of a k8s cluster, which usually is the cluster where the generators are deployed. If this is the case, <code>in_cluster</code> should be set to <code>false</code>, <code>true</code> for otherwise.</p>
<pre><code>    "executors": {
        "cluster": {
            "on_demand": false
        },
        "in_cluster": true,
        "namespace": "shibuya-executors", # this is the namespace where generators are deployed
        "jmeter": {
            "image": "shibuya:jmeter", 
            "cpu": "1", # resoures(requests) for the generator pod in a k8s cluster.
            "mem": "512Mi"
        },
        "pull_secret": "",
        "pull_policy": "IfNotPresent"
    }
</code></pre>
<h2 id="metrics-dashboard"><a class="header" href="#metrics-dashboard">Metrics dashboard</a></h2>
<p>Shibuya uses external Grafana dashboard to visualise the metrics.</p>
<pre><code>    "dashboard": {
        "url": "http://localhost:3000", # root of the dashboard url
        "run_dashboard": "/d/RXY8nM1mk2/shibuya", # link to the metrics of all the runs.
        "engine_dashboard": "/d/9EH6xqTZz/shibuya-engine-health" # link to the health of the engines.
    }
</code></pre>
<h2 id="object-storage-1"><a class="header" href="#object-storage-1">Object storage</a></h2>
<p>Shibuya uses object storage to store all the test plans. It supports two types storage:</p>
<ol>
<li>HTTP based storage service, like, Nexus.</li>
<li>GCP bucket.</li>
</ol>
<pre><code>    "object_storage": {
        "provider": "local", # either gcp, local, or Nexus
        "url": "http://storage:8080",
        "user": "", # HTTP basic authentication user and password
        "password": ""
    },
</code></pre>
<p>Please bear in mind, <code>local</code> should be only used by Shibuya developers.</p>
<h2 id="logging-support"><a class="header" href="#logging-support">Logging support</a></h2>
<pre><code>    "log_format": {
        "json": false
    }
</code></pre>
<p>If you require logs to be in JSON format, you can set <code>json: true</code>.</p>
<h2 id="gcp"><a class="header" href="#gcp">GCP</a></h2>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="object-storage-2"><a class="header" href="#object-storage-2">Object Storage</a></h1>
<p>In Shibuya, we support two types of object storage:</p>
<ol>
<li>Nexus(REST based)</li>
<li>GCP bucket</li>
</ol>
<h2 id="nexus"><a class="header" href="#nexus">Nexus</a></h2>
<p>Nexus provides a REST API for resource CRUD. HTTP Basic authentication is used. If the storage solution you are using is following the same API spec, it will also work.
Specifically:</p>
<div class="table-wrapper"><table><thead><tr><th>HTTP method</th><th>Resource operation</th></tr></thead><tbody>
<tr><td>GET</td><td>Get the resource</td></tr>
<tr><td>PUT</td><td>Upload the resource</td></tr>
<tr><td>DELETE</td><td>DELETE the resource</td></tr>
</tbody></table>
</div>
<p>All these method require HTTP basic authentication.</p>
<h2 id="gcp-1"><a class="header" href="#gcp-1">GCP</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-use-shibuya"><a class="header" href="#how-to-use-shibuya">How to use Shibuya</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="basic-concepts"><a class="header" href="#basic-concepts">Basic Concepts</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="shibuya-developers"><a class="header" href="#shibuya-developers">Shibuya developers</a></h1>
<p>If we split the work of Shibuya into two big categories, these are the two:</p>
<ol>
<li>Frontend(UI). They are mainly based on Boostrap and Vue.js.</li>
<li>Backend(API, controller, shibuya-agent). All of them are written in Go.</li>
</ol>
<h2 id="backend"><a class="header" href="#backend">Backend</a></h2>
<h3 id="api"><a class="header" href="#api">API</a></h3>
<p>Shibuya follows RESTful API standard. They can be found in <code>shibuya/api/main.go</code></p>
<h3 id="controller"><a class="header" href="#controller">Controller</a></h3>
<p>This is where the core Shibuya functionality is. Below is the core functionaties of the controller:</p>
<ol>
<li>Engines lifecycle management with the scheduler, Kubernetes is the only scheduler we are supporting. Lifecycle management includes launch/purge/healthcheck the engines.</li>
<li>Trigger engines and stop the tests engines. This will essentially start and stop the tests.</li>
<li>Stream the metrics generated by the engines, such as latency, thread number. and expose them as Prometheus metrics.</li>
</ol>
<p>Most of the above logic can be found in <code>shibuya/controller/engine.go</code></p>
<p>Engine is an abstraction name of load generator. Shibuya is designed to supported multiple load generators since day 1. Currently, the only load generator we are supporting is Apache Jmeter.</p>
<h3 id="metrics-streaming"><a class="header" href="#metrics-streaming">Metrics streaming</a></h3>
<p>Controller reads all the metrics from engines in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">Server Side Events</a>. The content of the events can be customised as you would need to write your own parser to parse the metrics and expose them via Prometheus. For example, you can check the current Jmeter logic at <code>shibuya/controller/jmeter.go</code></p>
<p>Since the controller is reading the events from the engine, the server side implementation also needs to be taken care of. We will discuss this part in the shibuya-agent.</p>
<h3 id="shibuya-agent"><a class="header" href="#shibuya-agent">shibuya-agent</a></h3>
<p>shibuya-agent is a process running alongside with load generator in order to work with controller. The main responsibility of the agent is:</p>
<ol>
<li>Take the HTTP requests from controller. Such as start the test, stop the test, healthcheck requests, etc</li>
<li>Forward the metrics generated by load generator back to the controller via SSE. The metrics have to be text based in order for streaming.</li>
</ol>
<p>For current Jmeter implementation, you can check here <code>shibuya/engines/jmeter/shibuya-agent.go</code></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
